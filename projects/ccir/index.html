<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>ccir | Andrew Gao</title> <meta name="author" content="Andrew Gao"> <meta name="description" content=""> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://agao1224.github.io/projects/ccir/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Andrew </span>Gao</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/booklist/">books</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">ccir</h1> <p class="post-description"></p> </header> <article> <p>My friend Kyle and I wrote a <a href="https://github.com/KyleleeSea/ccir" rel="external nofollow noopener" target="_blank">tiny C compiler in rust (ccir)</a> over winter break. It supports: variables (local, global), function calls, control-flow, loops, among other features. The compiler adheres to the C11 standard, cdecl calling convention, and compiles to x86-64 bit assembly. This was a pretty fun way to learn Rust while also exploring how compilers work. Much of compiler was written by Kyle, and I only helped out a little bit. He’s an amazing programmer, please check out <a href="https://github.com/KyleleeSea" rel="external nofollow noopener" target="_blank">his GitHub</a>!</p> <h3 id="lexer">Lexer</h3> <p>Our lexer expects a filepath, stores the contents as a string, then iterates over the string character-by-character. We initialize a token list and also create a set of tokens that represent various different elements the lexed program. We initialize an accumulator string which we append characters one-at-a-time to. If at any point the string represents a valid expression, keyword, etc in our program, we append the corresponding token at the end of the list along with necessary contextual information. For instance, if we come across something like:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (0 == 1)
</code></pre></div></div> <p>We append to our token list: <code class="language-plaintext highlighter-rouge">Token::TIf</code>, <code class="language-plaintext highlighter-rouge">Token::TIntLit(0)</code>, <code class="language-plaintext highlighter-rouge">Token::TEq</code>, <code class="language-plaintext highlighter-rouge">Token::TIntLit(1)</code>.</p> <p>When the lexing is finished, we return the list of tokens the program has been parsed into. If we encounter any unexpected elements in the program, we raise an error.</p> <h3 id="parser">Parser</h3> <p>The parser takes in the token list from our lexer and constructs an abstract syntax tree (AST) from it. To keep our parser clean and easy to reason about, we kept it as functional as possible (with some mutation) and used <a href="https://en.wikipedia.org/wiki/Backus%E2%80%93Naur_form" rel="external nofollow noopener" target="_blank">Backus-Naur Form</a>:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;function&gt; ::= "int" &lt;id&gt; "(" [ "int" &lt;id&gt; { "," "int" &lt;id&gt; } ] ")" ( "{" { &lt;block-item&gt; } "}" | ";" )
</code></pre></div></div> <p>This also helped us document code much more easily. Each function took the token stack and returned an ASTNode that handled implementing its own Grammar. Each function would call other parsing functions when it encountered certain tokens, and we had one top-level <code class="language-plaintext highlighter-rouge">parse_program</code> function that would take the token list created by the lexer and output the corresponding AST.</p> <h3 id="code-generation">Code Generation</h3> <p>The code generation structure is fairly similar to the parsing. We take in the root ASTNode and recurse down each child node. Depending on the tokens encountered, various different functions are called to process those subtrees. Processing some parts of the AST are tricky, especially when you need to “remember” certain things like: full registers, current location in the stack, declared variables and functions, etc. To handle things like variable and function declarations, we pass around <code class="language-plaintext highlighter-rouge">fn_validator</code> and <code class="language-plaintext highlighter-rouge">var_map</code>. <code class="language-plaintext highlighter-rouge">fn_validator</code> maps function IDs to their declaration and definition; <code class="language-plaintext highlighter-rouge">var_map</code> maps variable IDs to the register they currently occupy (or location on the stack) and value. This is just an example of one of the many things we’d had to implement for correct code generation. x86-64 assembly is written to <code class="language-plaintext highlighter-rouge">a.out</code>.</p> <h3 id="expanding-the-compiler">Expanding the Compiler</h3> <p>We talked about expanding ccir in all sorts of ways. Some of the improvements we’d like to make:</p> <ul> <li>More (primitive) types</li> <li>Comments, Macros</li> <li>Arrays, Structs, Unions</li> <li>Dynamic Memory Allocation</li> <li>Register Allocation, optimizations</li> <li>Importing packages</li> </ul> <p>Additionally, the error messages our compiler spits out currently aren’t very helpful. In the future, we’d like to improve on this. Some other more interesting and unorthodox features we were thinking of adding:</p> <ul> <li>Contracts (like <a href="https://dafny.org/" rel="external nofollow noopener" target="_blank">Dafny</a>)</li> <li>Stack Canaries</li> <li>Classes, Inheritance</li> </ul> <h3 id="resources-we-used">Resources We Used</h3> <ul> <li><a href="https://norasandler.com/archive/" rel="external nofollow noopener" target="_blank">Nora Sandler’s Writing a C Compiler</a></li> <li><a href="https://aaronbloomfield.github.io/pdr/book/x86-64bit-ccc-chapter.pdf" rel="external nofollow noopener" target="_blank">x86-64 calling convention</a></li> </ul> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>